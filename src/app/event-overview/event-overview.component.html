<div class="space-y-6">
  <h2 class="text-2xl font-semibold">Event Overview</h2>
  <p>Willkommen! Sie sind angemeldet als: <strong>{{ userRole }}</strong></p>

  <div *ngIf="userRole === 'eventmanager'" class="space-y-6">
    <mat-card appearance="outlined">
      <mat-card-header>
        <mat-card-title>Neues Event erstellen</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <form (ngSubmit)="createEvent()" class="grid gap-4 md:grid-cols-3">
          <mat-form-field appearance="outline" class="md:col-span-1">
            <mat-label>Titel</mat-label>
            <input matInput id="title" type="text" [(ngModel)]="newEvent.title" name="title" required pattern=".*\S.*" #titleCtrl="ngModel">
            <mat-error *ngIf="titleCtrl.errors?.['required']">Der Titel ist erforderlich.</mat-error>
            <mat-error *ngIf="titleCtrl.errors?.['pattern']">Der Titel darf nicht nur aus Leerzeichen bestehen.</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="md:col-span-1">
            <mat-label>Ort</mat-label>
            <mat-select id="location" [(ngModel)]="newEvent.locationId" name="locationId" required>
              <mat-option *ngFor="let loc of locations" [value]="loc.id">{{ loc.street }}</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="md:col-span-1">
            <mat-label>Datum &amp; Uhrzeit</mat-label>
            <input matInput id="eventDateTime" type="datetime-local" [(ngModel)]="newEvent.eventDateTime" name="eventDateTime" required #eventDateTimeCtrl="ngModel">
            <mat-error *ngIf="eventDateTimeCtrl.errors?.['required']">Datum und Uhrzeit sind erforderlich.</mat-error>
          </mat-form-field>

          <div class="md:col-span-3">
            <button mat-flat-button color="primary" type="submit">Event hinzufügen</button>
          </div>
        </form>
      </mat-card-content>
    </mat-card>

    <mat-card appearance="outlined">
      <mat-card-header>
        <mat-card-title>Neue Location hinzufügen</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <form (ngSubmit)="createLocation()" class="grid gap-4 md:grid-cols-4">
          <mat-form-field appearance="outline" class="md:col-span-2">
            <mat-label>Straße</mat-label>
            <input matInput id="street" type="text" [(ngModel)]="newLocation.street" name="street" required pattern=".*\S.*" #streetCtrl="ngModel">
            <mat-error *ngIf="streetCtrl.errors?.['required']">Die Straße ist erforderlich.</mat-error>
            <mat-error *ngIf="streetCtrl.errors?.['pattern']">Die Straße darf nicht nur aus Leerzeichen bestehen.</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Geo-Koordinate X</mat-label>
            <input matInput id="geoX" type="number" [(ngModel)]="newLocation.geoX" name="geoX" step="0.0001" min="-180" max="180" required pattern="^-?(180(\.0{1,4})?|[0-9]{1,2}(\.\d{1,4})?)$" #geoXCtrl="ngModel">
            <mat-error *ngIf="geoXCtrl.errors?.['required']">Dieses Feld ist erforderlich.</mat-error>
            <mat-error *ngIf="geoXCtrl.errors?.['min'] || geoXCtrl.errors?.['max']">Der Wert muss zwischen -180 und 180 liegen.</mat-error>
            <mat-error *ngIf="geoXCtrl.errors?.['pattern']">Bitte eine gültige Zahl mit maximal vier Nachkommastellen eingeben.</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Kapazität</mat-label>
            <input matInput id="capacity" type="text" [(ngModel)]="newLocation.capacity" name="capacity" required>
          </mat-form-field>

          <div class="md:col-span-4">
            <button mat-flat-button color="primary" type="submit">Location hinzufügen</button>
          </div>
        </form>
      </mat-card-content>
    </mat-card>

    <mat-card appearance="outlined">
      <mat-card-header>
        <mat-card-title>Neues Ticket erstellen</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <form (ngSubmit)="createTicket()" class="grid gap-4 md:grid-cols-3">
          <mat-form-field appearance="outline">
            <mat-label>Event auswählen</mat-label>
            <mat-select id="ticketEvent" [(ngModel)]="newTicket.eventId" name="eventId" required>
              <mat-option *ngFor="let event of data" [value]="event.id">{{ event.title }}</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Ticket Preis</mat-label>
            <input matInput id="ticketPrice" type="number" [(ngModel)]="newTicket.price" name="price" required step="0.01" min="0" pattern="^\d{1,10}(\.\d{1,2})?$" #ticketPriceCtrl="ngModel">
            <mat-error *ngIf="ticketPriceCtrl.errors?.['required']">Bitte geben Sie einen Preis ein.</mat-error>
            <mat-error *ngIf="ticketPriceCtrl.errors?.['min']">Der Preis muss 0 oder höher sein.</mat-error>
            <mat-error *ngIf="ticketPriceCtrl.errors?.['pattern']">Der Preis darf maximal 10 Stellen vor dem Komma und höchstens 2 Nachkommastellen haben.</mat-error>
          </mat-form-field>

          <div class="md:col-span-3">
            <button mat-flat-button color="primary" type="submit">Ticket erstellen</button>
          </div>
        </form>
      </mat-card-content>
    </mat-card>
  </div>

  <mat-card appearance="outlined">
    <mat-card-header>
      <mat-card-title>Event-Liste</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div *ngIf="data && data.length > 0; else loading" class="space-y-2">
        <mat-nav-list>
          <a mat-list-item *ngFor="let item of data">
            <mat-checkbox [disabled]="(item?.availableTickets  < 0)" (change)="toggleEventSelection(item.id, $event.checked)"></mat-checkbox>
            <div matListItemTitle>{{ item.title }}</div>
            <div matListItemLine>{{ item.location?.street }} — {{ item?.eventDateTime | date:'dd.MM.yyyy HH:mm' }}</div>
            <div matListItemLine class="text-sm text-gray-500 dark:text-gray-400">
              Ticket Preis: {{ item.tickets[0].price }} · Kapazität: {{item.location?.capacity}} · Verfügbare Tickets: {{ item?.availableTickets > 0 ? item?.availableTickets : 'Keine Tickets mehr verfügbar' }}
            </div>
            <span class="flex-1"></span>
            <button mat-stroked-button color="warn" *ngIf="userRole === 'eventmanager'" (click)="deleteEvent(item.id)">Event löschen</button>
          </a>
        </mat-nav-list>
        <div class="pt-2">
          <button mat-flat-button color="primary" (click)="orderTickets()">Ticket bestellen</button>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <div *ngIf="userRole === 'eventmanager'" class="space-y-6">
    <mat-card appearance="outlined">
      <mat-card-header>
        <mat-card-title>Location-Liste</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div *ngIf="locations && locations.length > 0; else loading">
          <mat-nav-list>
            <a mat-list-item *ngFor="let loc of locations">
              <div matListItemTitle>{{ loc.street }}</div>
              <div matListItemLine>{{ loc.geoX }}, {{ loc.geoY }} · Kapaziät: {{loc.capacity}}</div>
              <span class="flex-1"></span>
              <button mat-stroked-button color="warn" (click)="deleteLocation(loc.id)">Ticket löschen</button>
            </a>
          </mat-nav-list>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card appearance="outlined">
      <mat-card-header>
        <mat-card-title>Ticket-Liste (nur verfügbare Tickets)</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div *ngIf="tickets && tickets.length > 0; else loading">
          <mat-nav-list>
            <a mat-list-item *ngFor="let ticket of tickets">
              <div matListItemTitle>Ticket ID: {{ ticket.id }} — Preis: {{ ticket.price }}</div>
              <div matListItemLine>Event: {{ getEventTitle(ticket) }}</div>
              <span class="flex-1"></span>
              <button mat-stroked-button color="warn" (click)="deleteTicket(ticket.id)">Ticket löschen</button>
            </a>
          </mat-nav-list>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <div>
    <button mat-stroked-button (click)="showDashboard()">Dashboard</button>
  </div>

  <ng-template #loading>
    <p>Lade Daten...</p>
  </ng-template>
</div>
